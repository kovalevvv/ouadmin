<div class="container-fluid">
  <h1 class="mt-4">New user</h1>
  <ol class="breadcrumb mb-4">
      <li class="breadcrumb-item"><a href="<%= admin_dashboard_path %>">Dashboard</a></li>
      <li class="breadcrumb-item active">New user</li>
  </ol>
  <div class="alert alert-primary" id="dn_info">
      <%= Setting.ou_dn %>
  </div>
  <%= form_tag({:controller => 'admin', :action => 'create_ou_user'}, :id => 'create_logon_form', :remote => true) do %>
    <div class="col-md-5">
    <div class="form-group">
        <label for="lastname">Last name</label>
        <input type="text" name="sn" id="lastname" class="form-control form-control-lg" placeholder="Фамилия" value="<%= @user.lastname if @user %>" required>
    </div>
    <div class="form-group">
      <label for="firstname">First name</label>
      <input type="text" name="givenName" id="firstname" class="form-control form-control-lg" placeholder="Имя" value="<%= @user.firstname if @user %>" required>
    </div>
    <div class="form-group">
      <label for="secondname">Second name</label>
      <input type="text" name="secondname" id="secondname" class="form-control form-control-lg" placeholder="Отчество" value="<%= @user.secondname if @user %>" required>
    </div>
    <fieldset disabled>
      <div class="form-group">
        <label for="fullname">Full name</label>
        <input type="text" name="cn" class="form-control" id="fullname" aria-describedby="fullnameHelp" placeholder="">
        <small id="fullnameHelp" class="form-text text-muted">Generates automatically</small>
      </div>
    </fieldset>
    <label for="logonname">User logon name</label>
    <div class="input-group">
      <input type="text" name="sAMAccountName" class="form-control" id="logonname" placeholder="" required value="">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" onclick="javascript:generate_or_check_logon();"><%= octicon "checklist" %></button>
      </div>
    </div>
    <label for="email">Email address</label>
     <div class="input-group mb-3">
      <input type="email" name="mail" class="form-control" id="email" aria-describedby="emailHelp" value="<%= @user.email if @user %>" placeholder="Enter email" onblur="javascript:check_email();">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" onclick="javascript:check_email();"><%= octicon "checklist" %></button>
      </div>
    </div>
    <% unless @user %>
    <label for="password">Password</label>
    <div class="input-group mb-3">
      <input type="password" name="userPassword" class="form-control pwd" id="password" placeholder="password" autocomplete="new-password" value="<%= Passgen::generate :digits => true, :length => 10 %>" required>
      <div class="input-group-append">
        <button class="btn btn-outline-secondary reveal" type="button"><%= octicon "eye-closed" %></button>
      </div>
    </div>
    <div class="custom-control custom-checkbox">
      <input type="checkbox" name="msDS-UserAccountDisabled" class="custom-control-input" id="userenable" value="true">
      <label class="custom-control-label" for="userenable">User enable?</label>
    </div>
    <div class="custom-control custom-checkbox">
      <input type="checkbox" class="custom-control-input" id="resetemail" name="resetemail" value="true" checked="checked">
      <label class="custom-control-label" for="resetemail">Send an email with a password reset link?</label>
    </div>
    <% else %>
      <%= hidden_field_tag :user_id, @user.id %>
    <% end %>
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <button type="submit" class="btn-lg btn-primary float-right">Create</button>
    </div>
  <% end %>
</div>
<%= content_for :scripts do %>
  <%= javascript_tag do %>
  $(document).ready((function(){
    function generate_cn() {
      $('input#fullname').val(`${$('input#lastname').val()} ${$('input#firstname').val()} ${$('input#secondname').val()}`)
    }
    $('input#lastname').change(generate_cn()).keyup(generate_cn)
    $('input#firstname').change(generate_cn()).keyup(generate_cn)
    $('input#secondname').change(generate_cn()).keyup(generate_cn)
  }))

  $("#create_logon_form").on('ajax:beforeSend', function() {
    if (!$('#email').val()) {
      return confirm("Create user with empty email?")
    } else {
      check_email()
      if (!email_validate) {
        return confirm("Create user with not valid email?")
      }
      return true
    }
  });

  function generate_or_check_logon() {
    var data = $("#create_logon_form").serialize();
    $.ajax({
        type: "POST",
        url: "<%= admin_generate_or_check_logon_path %>",
        data: data,
        dataType: "script"
    });
  }

  function check_email() {
    var data = $("#create_logon_form").serialize();
    $.ajax({
        type: "POST",
        url: "<%= admin_check_email_path %>",
        data: data,
        dataType: "script"
    });
  }

  $(".reveal").on('click',function() {
    var pwd = $(".pwd");
    if (pwd.attr('type') === 'password') {
        pwd.attr('type', 'text');
        $(this).html('<%= j octicon "eye" %>')
    } else {
        pwd.attr('type', 'password');
        $(this).html('<%= j octicon "eye-closed" %>')
    }
});

  <% end %>
<% end %>